---
title: "EMA Actigraphy merge"
output:
  pdf_document: default
  html_notebook: default
---

The goal is to derive a tidy EMA data-set including a data dictionary for CHARMS (and SPEAK) participants which is merged with the GENEActiv GGIR accelerometry (sleep) data. 

I have copied the raw EMA data (completely untouched) from /Users/jessicahartmann/OneDrive/Data and files from Orygen server june 2021/CHARMS/EMA data/EXTRACTED DATA into the current home directory 


### Getting data into  R

Load required packages

```{r}
library(plyr)
library(readr)
library(dplyr)
library(readxl)
```

Read files into a list, then read in the list
```{r}
myfiles = list.files(path = "extracted_data", pattern="*.csv", full.names=TRUE)
ema_df <- ldply(myfiles, read.csv)
```

### Some tidying 

Keep only surveys which have answers 
```{r}
ema_df <- ema_df %>%
        filter (HAS_ANSWERS == "YES") 
```


Make overiew of how many surveys have been answered by participants (note: there are some test subjects still in there which will be removed later)
```{r}
ema_n <- ema_df %>% 
        group_by(PARTICIPANT_ID) %>%
        summarise(n = n()) 
```

The EMA dataset comes with its own participant id's. Now we need to add the "official" CHARMS ID which is included in Codebook_ID. 

```{r}
ids <- read_excel("Codebook_IDs.xlsx")
ema_df<- merge(ema_df, ids, by = "PARTICIPANT_ID")


ema_m <- ema_df %>%
  merge(ids, by = "PARTICIPANT_ID") %>%  ##merge both datasets
  select("CHARMS_ID.x", everything()) %>%  ##reorder with CHARMS ID as first column
  subset(!is.na("CHARMS_ID.x"))       ## only keep the observations which have a CHARMS ID
```

```{r}
#write.csv(ema_m, "ema_merged.csv") ##for Holly 
```


### How many unique people are in this EMA data set?

```{r}
idlist <- unique(ema_m$CHARMS_ID.x) ##make a vector 
length(idlist) ##length of the vector 
```

OK, we have N = 14 people in the EMA data. 

### Aggregate EMA measures at day-level 

For Holly's project, we will aggregate the dataset to one EMA observation per person per day. This makes it easier to work with and understand the data (though losing some power)  

 Convert to **date** 
```{r}
ema_m$COMPLETED <- as.Date(ema_m$COMPLETED, format = "%d/%m/%Y")

## there are a few observations with invalid date, exclude these. Check with Ann Ee why 
ema_m <- ema_m[ which(ema_m$COMPLETED > 01/01/1970),] 
```

Create data frame with only one observation per individual per day and keep only relevant variables. This can then be merged with the sleep day summary data. 
```{r}

ema_perday <- ema_m %>% 
            group_by(CHARMS_ID.x, COMPLETED) %>% 
            select (-c(ITERATION, PROGRAM_VERSION, SURVEY, HAS_ANSWERS, 
                              DELIVERED, EXPIRED, UPLOADED)) %>% ## exclude non-relevant columns
            summarise(across(where(is.numeric), list(mean), na.rm = TRUE)) ## calculate the day mean
            
```
```{r}
##rename charms id and date for merging 
ema_perday <- rename(ema_perday, ID = CHARMS_ID.x, calendar_date = COMPLETED) 
```

## Calculating positive affect (PA) and negative affect (NA) 


**PA**: As per Ann Ee's thesis, calculate PA out of the following items: Cheerful, enthousiastic, down (reverse coded). 
**NA**: As per Ann Ee's thesis, calculate NA out of the following items: lonely, insecure, anxious, guilty, relaxed (reverse coded)


```{r}
## reverse score down 

ema_perday <- ema_perday %>%
              mutate(DOWNrev = 101 - DOWN_1) %>% ## reverse score down 
              mutate(RELAXrev = 101 - RELAXED_1) %>%
              mutate(pa = (CHEERF_1 + ENTHOUS_1 + DOWNrev)/3) %>% ## calculate PA
              mutate(na = (LONELY_1 + INSECURE_1 + ANXIOUS_1 + GUILTY_1 + 
                             RELAXrev)/5) ## calculate NA

```


## sleep data 

Read in sleep data 
```{r}
ggir <- read.csv("../GGIR/McKenzie_results/output_McKenzie_data/results/part5_daysummary_WW_L30M100V400_T5A5.csv")
```

Merge data sets 

```{r}
ema_sleep_all <- merge(ema_perday, ggir, all = TRUE) ## all observations, not just 
                                                     ## matched ones
```

Sort and order 

```{r}
ema_sleep_all <- ema_sleep_all %>%
                relocate(ID, calendar_date, pa, na, sleeponset, sleeponset_ts, 
                         wakeup, wakeup_ts, night_number, dur_spt_sleep_min:daytype)

ema_sleep_all <- ema_sleep_all[!is.na(ema_sleep_all$ID),]  ##exclude obs without ID          
```

save to send to Holly 

```{r}
write.csv(ema_sleep_all, "ema_sleep_merged.csv")
```



